var mouseX=mouseY=mouseOldX=mouseOldY=0,C,c,viewWidth,viewHeight,triW=window.cnblogsConfig.essayTopAnimation.triW,triH=window.cnblogsConfig.essayTopAnimation.triH,neighbours=window.cnblogsConfig.essayTopAnimation.neighbours,speedTrailAppear=window.cnblogsConfig.essayTopAnimation.speedTrailAppear,speedTrailDisappear=window.cnblogsConfig.essayTopAnimation.speedTrailDisappear,speedTriOpen=window.cnblogsConfig.essayTopAnimation.speedTriOpen,trailMaxLength=window.cnblogsConfig.essayTopAnimation.trailMaxLength,trailIntervalCreation=window.cnblogsConfig.essayTopAnimation.trailIntervalCreation,delayBeforeDisappear=window.cnblogsConfig.essayTopAnimation.delayBeforeDisappear,cols,rows,tris,randomAlpha=true,colors=window.cnblogsConfig.essayTopAnimation.colors;Triangle=function(e,b,d){var a=this;this.selectedForTrail=false;this.pos=e;this.col=b;this.row=d;this.alpha=this.tAlpha=1;this.color=colors[Math.floor(Math.random()*colors.length)];this.rgb=hexToRgb(this.color);this.opened=false;this.opening=false;this.closing=false;this.isLeft=(this.pos%2);this.tX1=(this.isLeft)?(this.col+1)*triW:this.col*triW;this.tX2=(this.isLeft)?this.col*triW:(this.col+1)*triW;this.tX3=(this.isLeft)?(this.col+1)*triW:this.col*triW;this.x1=this.tX1;this.x2=this.tX1;this.x3=this.tX1;this.tY1=0.5*this.row*triH;this.tY2=0.5*(this.row+1)*triH;this.tY3=0.5*(this.row+2)*triH;this.y1=this.tY1;this.y2=this.tY1;this.y3=this.tY1;this.tweenClose,this.tweenOpen;this.draw=function(){c.fillStyle="rgba("+this.rgb.r+","+this.rgb.g+","+this.rgb.b+","+this.alpha+")";c.beginPath();c.moveTo(this.x1,this.y1);c.lineTo(this.x2,this.y2);c.lineTo(this.x3,this.y3);c.closePath();c.fill()};this.open=function(i,g,h,f){if(!this.opened||!this.opening){if(this.tweenClose){this.tweenClose.kill()}this.opening=true;this.direction=i||"top";this.delay=f||0;this.tAlpha=h;this.tSpeed=g||1.5;if(this.direction=="side"){this.x1=this.x2=this.x3=this.tX1;this.y1=this.tY1;this.y2=this.tY2;this.y3=this.tY3}else{if(this.direction=="top"){this.x1=(this.tX2+this.tX3)/2;this.x2=this.tX2;this.x3=this.tX3;this.y1=(this.tY2+this.tY3)/2;this.y2=this.tY2;this.y3=this.tY3}else{if(this.direction=="bottom"){this.x1=this.tX1;this.x2=this.tX2;this.x3=(this.tX1+this.tX2)/2;this.y1=this.tY1;this.y2=this.tY2;this.y3=(this.tY1+this.tY2)/2}}}this.tweenOpen=TweenMax.to(this,this.tSpeed,{x1:this.tX1,x2:this.tX2,x3:this.tX3,y1:this.tY1,y2:this.tY2,y3:this.tY3,alpha:this.tAlpha,ease:Strong.easeInOut,delay:this.delay,onComplete:openComplete,onCompleteParams:[a]})}};this.close=function(l,m,g){this.direction=l||"top";this.delay=g||1;this.tSpeed=m||0.8;this.opened=false;this.closing=true;var k,j,i,h,f,n;if(this.direction=="side"){k=j=i=this.tX1;h=this.tY1;f=this.tY2;n=this.tY3}else{if(this.direction=="top"){k=(this.tX2+this.tX3)/2;j=this.tX2;i=this.tX3;h=(this.tY2+this.tY3)/2;f=this.tY2;n=this.tY3}else{if(this.direction=="bottom"){k=this.tX1;j=this.tX2;i=(this.tX1+this.tX2)/2;h=this.tY1;f=this.tY2;n=(this.tY1+this.tY2)/2}}}if(this.tweenClose){this.tweenClose.kill()}this.tweenClose=TweenMax.to(this,this.tSpeed,{x1:k,x2:j,x3:i,y1:h,y2:f,y3:n,alpha:0,ease:Strong.easeInOut,delay:this.delay,onComplete:closeComplete,onCompleteParams:[a]})}};function openComplete(a){a.opened=true;a.opening=false;a.closing=false}function closeComplete(a){a.opened=false;a.opening=false;a.closing=false}function unselectTris(){for(var a=0;a<tris.length;a++){tris[a].selectedForTrail=false}}function createTrail(){unselectTris();var f;var a=Math.floor(Math.random()*trailMaxLength-2)+2;var d=Math.round(Math.random()*tris.length);startTri=tris[d];if(typeof(startTri)!="undefined"&&typeof(startTri.selectedForTrail)!="undefined"){startTri.selectedForTrail=true}else{return false}f={tri:startTri,openDir:"side",closeDir:"side"};for(var e=0;e<a;e++){var g=getNeighbour(f.tri);if(g!=null){g.tri.selectedForTrail=true;var b;if(randomAlpha){b=(Math.random()<0.8)?Math.random()*0.5:1}else{b=1}f.tri.closeDir=g.openDir;f.tri.open(f.openDir,speedTriOpen,b,e*speedTrailAppear);f.tri.close(f.closeDir,1,delayBeforeDisappear+e*speedTrailDisappear);f=g}else{f.tri.open(f.openDir,speedTriOpen,b,(e+1)*speedTrailAppear);f.tri.close(f.closeDir,1,delayBeforeDisappear+(e+1)*speedTrailDisappear);break}}}function getNeighbour(b){shuffleArray(neighbours);for(var a=0;a<neighbours.length;a++){if(neighbours[a]=="top"){if(b.row!=0&&!tris[b.pos-cols].selectedForTrail&&!tris[b.pos-cols].opened){return{tri:tris[b.pos-cols],openDir:"top",closeDir:"top"}}}else{if(neighbours[a]=="bottom"){if(b.row!=rows-1&&!tris[b.pos+cols].selectedForTrail&&!tris[b.pos+cols].opened){return{tri:tris[b.pos+cols],openDir:"bottom",closeDir:"top"}}}else{if(b.isLeft&&b.col!=cols-1&&!tris[b.pos+1].selectedForTrail&&!tris[b.pos+1].opened){return{tri:tris[b.pos+1],openDir:"side",closeDir:"top"}}else{if(!b.isLeft&&b.col!=0&&!tris[b.pos-1].selectedForTrail&&!tris[b.pos-1].opened){return{tri:tris[b.pos-1],openDir:"side",closeDir:"top"}}}}}}return null}function draw(){c.clearRect(0,0,C.width,C.height);for(var a=0;a<tris.length;a++){tris[a].draw()}}function handleResize(){viewWidth=C.width=C.scrollWidth;viewHeight=C.height=C.scrollHeight;rectCanvas=C.getBoundingClientRect();start()}function hexToRgb(b){var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b);return a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null}function shuffleArray(e){for(var b,a,d=e.length;d;b=Math.floor(Math.random()*d),a=e[--d],e[d]=e[b],e[b]=a){}return e}function initCanvas(a){C=document.getElementById(a),c=C.getContext("2d"),viewWidth=C.width=C.scrollWidth,viewHeight=C.height=C.scrollHeight,initParams();window.addEventListener("resize",handleResize);TweenLite.ticker.addEventListener("tick",draw);handleResize()}function initParams(){cols=Math.floor(viewWidth/triW);cols=(cols%2)?cols:cols-1;rows=Math.floor(viewHeight/triH)*2;tris=[]}function initGrid(){for(var a=0;a<rows;a++){for(var b=0;b<cols;b++){var e=b+(a*cols);var d=new Triangle(e,b,a);tris.push(d);d.draw()}}}var interval;function start(){if(interval){clearInterval(interval)}initParams();initGrid();interval=setInterval(createTrail,trailIntervalCreation);createTrail()}function pause(){if(interval){clearInterval(interval)}for(var a=0;a<tris.length;a++){if(tris[a].tweenClose){tris[a].tweenClose.kill()}}}function closeAll(){var b=0;if(interval){clearInterval(interval)}for(var a=0;a<tris.length;a++){if(tris[a].tweenOpen){tris[a].tweenOpen.kill()}if(tris[a].opened||tris[a].opening){b++;tris[a].close("top",0.8,0.2+0.0015*b)}}}function kill(){if(interval){clearInterval(interval)}for(var a=0;a<tris.length;a++){TweenLite.killTweensOf(tris[a]);tris[a].alpha=0}};